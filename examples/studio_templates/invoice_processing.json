{
  "id": "tpl-invoice-processing",
  "version": "1.0.0",
  "name": "Invoice Processing",
  "description": "Extract invoice data with AI, validate amounts, route high-value invoices for manual approval, and push approved invoices to accounting",
  "settings": {
    "default_model": "gemini-2.0-flash",
    "env_vars": {},
    "layoutDirection": "LR",
    "layoutMode": "free",
    "debugMode": false
  },
  "agents": {
    "invoice_extractor": {
      "type": "llm",
      "model": "gemini-2.0-flash",
      "instruction": "You are an invoice data extraction specialist. Given raw invoice text or OCR output, extract structured data.\n\nExtract these fields:\n- vendor_name: Company name on the invoice\n- invoice_number: Unique invoice ID\n- invoice_date: Date issued (ISO format)\n- due_date: Payment due date (ISO format)\n- line_items: Array of {description, quantity, unit_price, total}\n- subtotal: Before tax\n- tax_amount: Tax charged\n- total_amount: Final amount due\n- currency: 3-letter code (USD, EUR, etc.)\n- payment_terms: Net 30, Net 60, etc.\n\nOutput JSON only. If a field is missing, use null.",
      "tools": [],
      "sub_agents": [],
      "position": { "x": 0, "y": 0 }
    }
  },
  "tools": {},
  "tool_configs": {},
  "actionNodes": {
    "manual_trigger": {
      "type": "trigger",
      "id": "manual_trigger",
      "name": "Invoice Received",
      "description": "Triggered when a new invoice arrives via email or upload",
      "triggerType": "manual",
      "manual": {
        "buttonLabel": "Process Invoice",
        "defaultPrompt": "INVOICE #INV-2026-0847\nFrom: Acme Cloud Services LLC\nDate: 2026-02-01\nDue: 2026-03-03\n\nItems:\n- Cloud Compute (Standard) x 120 hours @ $0.45/hr = $54.00\n- Cloud Storage (500GB) x 1 month @ $23.00 = $23.00\n- Premium Support x 1 month @ $199.00 = $199.00\n\nSubtotal: $276.00\nTax (8.5%): $23.46\nTotal: $299.46\nTerms: Net 30",
        "showPromptInput": true
      },
      "errorHandling": { "mode": "stop" },
      "tracing": { "enabled": true, "logLevel": "info" },
      "callbacks": {},
      "execution": { "timeout": 30000 },
      "mapping": { "outputKey": "trigger_input" }
    },
    "validate_amounts": {
      "type": "transform",
      "id": "validate_amounts",
      "name": "Validate Amounts",
      "description": "Verify line item totals match subtotal and tax calculation is correct",
      "transformExpression": "{ valid: (Math.abs(input.subtotal + input.tax_amount - input.total_amount) < 0.01), computed_subtotal: input.line_items.reduce((s, i) => s + i.total, 0), discrepancy: Math.abs(input.line_items.reduce((s, i) => s + i.total, 0) - input.subtotal) }",
      "inputKey": "extracted_invoice",
      "errorHandling": { "mode": "continue" },
      "tracing": { "enabled": true, "logLevel": "info" },
      "callbacks": {},
      "execution": { "timeout": 5000 },
      "mapping": { "outputKey": "validation" }
    },
    "route_approval": {
      "type": "switch",
      "id": "route_approval",
      "name": "Approval Routing",
      "description": "Route based on invoice amount: >$5000 needs VP approval, >$1000 needs manager, rest auto-approved",
      "evaluationMode": "first_match",
      "conditions": [
        { "id": "vp", "name": "VP Approval (>$5K)", "field": "extracted_invoice.total_amount", "operator": "gt", "value": "5000", "outputPort": "vp_approval" },
        { "id": "mgr", "name": "Manager Approval (>$1K)", "field": "extracted_invoice.total_amount", "operator": "gt", "value": "1000", "outputPort": "mgr_approval" }
      ],
      "defaultBranch": "auto_approved",
      "errorHandling": { "mode": "stop" },
      "tracing": { "enabled": true, "logLevel": "info" },
      "callbacks": {},
      "execution": { "timeout": 5000 },
      "mapping": { "outputKey": "approval_route" }
    },
    "set_vp": {
      "type": "set",
      "id": "set_vp",
      "name": "VP Review Required",
      "description": "Flag for VP approval with high-priority SLA",
      "mode": "set",
      "variables": [
        { "key": "approval_level", "value": "vp", "valueType": "string", "isSecret": false },
        { "key": "approver_email", "value": "vp-finance@company.com", "valueType": "string", "isSecret": false },
        { "key": "sla_hours", "value": "24", "valueType": "number", "isSecret": false },
        { "key": "status", "value": "pending_vp_approval", "valueType": "string", "isSecret": false }
      ],
      "errorHandling": { "mode": "stop" },
      "tracing": { "enabled": true, "logLevel": "info" },
      "callbacks": {},
      "execution": { "timeout": 5000 },
      "mapping": { "outputKey": "approval_info" }
    },
    "set_mgr": {
      "type": "set",
      "id": "set_mgr",
      "name": "Manager Review Required",
      "description": "Flag for manager approval",
      "mode": "set",
      "variables": [
        { "key": "approval_level", "value": "manager", "valueType": "string", "isSecret": false },
        { "key": "approver_email", "value": "finance-manager@company.com", "valueType": "string", "isSecret": false },
        { "key": "sla_hours", "value": "48", "valueType": "number", "isSecret": false },
        { "key": "status", "value": "pending_manager_approval", "valueType": "string", "isSecret": false }
      ],
      "errorHandling": { "mode": "stop" },
      "tracing": { "enabled": true, "logLevel": "info" },
      "callbacks": {},
      "execution": { "timeout": 5000 },
      "mapping": { "outputKey": "approval_info" }
    },
    "set_auto": {
      "type": "set",
      "id": "set_auto",
      "name": "Auto-Approved",
      "description": "Small invoices are auto-approved",
      "mode": "set",
      "variables": [
        { "key": "approval_level", "value": "auto", "valueType": "string", "isSecret": false },
        { "key": "status", "value": "approved", "valueType": "string", "isSecret": false }
      ],
      "errorHandling": { "mode": "stop" },
      "tracing": { "enabled": true, "logLevel": "info" },
      "callbacks": {},
      "execution": { "timeout": 5000 },
      "mapping": { "outputKey": "approval_info" }
    },
    "merge_approvals": {
      "type": "merge",
      "id": "merge_approvals",
      "name": "Merge Approvals",
      "description": "Rejoin approval branches",
      "mode": "wait_all",
      "combineStrategy": "object",
      "timeout": { "enabled": true, "ms": 15000, "behavior": "continue" },
      "errorHandling": { "mode": "continue" },
      "tracing": { "enabled": true, "logLevel": "info" },
      "callbacks": {},
      "execution": { "timeout": 20000 },
      "mapping": { "outputKey": "merged_approval" }
    },
    "push_to_accounting": {
      "type": "http",
      "id": "push_to_accounting",
      "name": "Push to QuickBooks",
      "description": "Create a bill in QuickBooks Online",
      "method": "POST",
      "url": "https://quickbooks.api.intuit.com/v3/company/{{QB_COMPANY_ID}}/bill",
      "auth": { "type": "bearer", "bearer": { "token": "{{QB_ACCESS_TOKEN}}" } },
      "headers": { "Content-Type": "application/json", "Accept": "application/json" },
      "body": {
        "type": "json",
        "content": "{\"VendorRef\": {\"name\": \"{{extracted_invoice.vendor_name}}\"}, \"TotalAmt\": {{extracted_invoice.total_amount}}, \"DueDate\": \"{{extracted_invoice.due_date}}\"}"
      },
      "response": { "type": "json" },
      "errorHandling": { "mode": "retry", "retryCount": 2, "retryDelay": 2000 },
      "tracing": { "enabled": true, "logLevel": "info" },
      "callbacks": {},
      "execution": { "timeout": 15000 },
      "mapping": { "outputKey": "accounting_result" }
    }
  },
  "workflow": {
    "type": "graph",
    "edges": [
      { "from": "manual_trigger", "to": "START" },
      { "from": "START", "to": "invoice_extractor" },
      { "from": "invoice_extractor", "to": "validate_amounts" },
      { "from": "validate_amounts", "to": "route_approval" },
      { "from": "route_approval", "to": "set_vp", "fromPort": "vp_approval" },
      { "from": "route_approval", "to": "set_mgr", "fromPort": "mgr_approval" },
      { "from": "route_approval", "to": "set_auto", "fromPort": "auto_approved" },
      { "from": "set_vp", "to": "merge_approvals" },
      { "from": "set_mgr", "to": "merge_approvals" },
      { "from": "set_auto", "to": "merge_approvals" },
      { "from": "merge_approvals", "to": "push_to_accounting" },
      { "from": "push_to_accounting", "to": "END" }
    ],
    "conditions": []
  },
  "created_at": "2026-02-08T00:00:00Z",
  "updated_at": "2026-02-08T00:00:00Z"
}