name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  # cmake 4.x compat for audiopus
  CMAKE_POLICY_VERSION_MINIMUM: "3.5"
  PROTOC: protoc

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        df -h

    # 1. Install Nix
    - uses: cachix/install-nix-action@v30
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    # 2. Use the 'devenv' cache (Crucial for devenv-nixpkgs)
    - uses: cachix/cachix-action@v15
      with:
        name: devenv

    # 3. Install devenv CLI
    - name: Install devenv.sh
      run: nix profile install nixpkgs#devenv

    - name: Cache Devenv/Cargo artifacts
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/sccache
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: devenv-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          devenv-${{ runner.os }}-cargo-

    - name: Check formatting
      run: |
        echo "üé® Starting formatting check..."
        devenv shell ws-fmt

    - name: Run clippy
      run: |
        echo "üîç Starting clippy lints..."
        devenv shell ws-clippy --message-format=json | tee clippy.json

    - name: Run tests
      run: |
        echo "üß™ Starting workspace tests..."
        devenv shell ws-test | tee test.log

    - name: Generate Summary
      if: always()
      run: |
        echo "üìä Generating CI summary..."
        devenv shell ws-summary
